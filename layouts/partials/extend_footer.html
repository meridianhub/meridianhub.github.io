<!--
  Mermaid.js for architecture diagrams

  SECURITY NOTE: securityLevel='loose' is required for full Mermaid functionality
  including click handlers and entity relationships. This is acceptable because:
  - All content is author-controlled (no user-submitted diagrams)
  - Mermaid is loaded from jsdelivr CDN with integrity verification

  If user-submitted diagrams are ever supported, change to securityLevel='strict'
-->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Hugo/Chroma renders ```mermaid blocks as <pre class="chroma"><code class="language-fallback">
  // because Chroma doesn't recognize "mermaid" as a language.
  // We detect mermaid blocks by looking for code starting with mermaid keywords.
  const mermaidKeywords = ['graph ', 'flowchart ', 'sequenceDiagram', 'classDiagram', 'stateDiagram', 'erDiagram', 'gantt', 'pie ', 'gitGraph'];

  // Handle markdown code blocks (pre.chroma > code)
  const codeBlocks = Array.from(document.querySelectorAll('pre.chroma code')).filter(code => {
    const text = code.textContent.trim();
    return mermaidKeywords.some(keyword => text.startsWith(keyword));
  });

  codeBlocks.forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = codeBlock.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Handle direct <pre class="mermaid"> elements (from HTML templates)
  const preMermaidBlocks = document.querySelectorAll('pre.mermaid');
  preMermaidBlocks.forEach((pre) => {
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = pre.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Check if we have any mermaid content to render
  const hasMermaid = codeBlocks.length > 0 || preMermaidBlocks.length > 0;

  if (hasMermaid) {
    mermaid.initialize({
      startOnLoad: false,
      theme: 'neutral',
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true
      }
    });

    // Manually render all .mermaid elements
    mermaid.run().catch(err => console.error('Mermaid render error:', err));
  }
</script>
