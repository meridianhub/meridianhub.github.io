<!--
  Mermaid.js for architecture diagrams

  SECURITY NOTE: securityLevel='loose' is required for full Mermaid functionality
  including click handlers and entity relationships. This is acceptable because:
  - All content is author-controlled (no user-submitted diagrams)
  - Mermaid is loaded from jsdelivr CDN with integrity verification

  If user-submitted diagrams are ever supported, change to securityLevel='strict'
-->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Hugo/Chroma renders ```mermaid blocks as <pre class="chroma"><code class="language-fallback">
  // because Chroma doesn't recognize "mermaid" as a language.
  // We detect mermaid blocks by looking for code starting with mermaid keywords.
  const mermaidKeywords = ['graph ', 'flowchart ', 'sequenceDiagram', 'classDiagram', 'stateDiagram', 'erDiagram', 'gantt', 'pie ', 'gitGraph'];

  // Handle markdown code blocks (pre.chroma > code)
  const codeBlocks = Array.from(document.querySelectorAll('pre.chroma code')).filter(code => {
    const text = code.textContent.trim();
    return mermaidKeywords.some(keyword => text.startsWith(keyword));
  });

  codeBlocks.forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = codeBlock.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Handle direct <pre class="mermaid"> elements (from HTML templates)
  const preMermaidBlocks = document.querySelectorAll('pre.mermaid');
  preMermaidBlocks.forEach((pre) => {
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = pre.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Check if we have any mermaid content to render
  const hasMermaid = codeBlocks.length > 0 || preMermaidBlocks.length > 0;

  if (hasMermaid) {
    // Detect dark mode from PaperMod's data-theme attribute
    const getTheme = () => document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'neutral';

    const renderMermaid = () => {
      mermaid.initialize({
        startOnLoad: false,
        theme: getTheme(),
        securityLevel: 'loose',
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true
        }
      });
      mermaid.run().catch(err => console.error('Mermaid render error:', err));
    };

    // Initial render
    renderMermaid();

    // Re-render when theme changes (PaperMod toggles data-theme attribute)
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-theme') {
          // Clear existing diagrams and re-render
          document.querySelectorAll('.mermaid[data-processed="true"]').forEach(el => {
            el.removeAttribute('data-processed');
            el.innerHTML = el.getAttribute('data-original') || el.textContent;
          });
          renderMermaid();
        }
      });
    });

    observer.observe(document.documentElement, { attributes: true });

    // Store original content for re-rendering
    document.querySelectorAll('.mermaid').forEach(el => {
      el.setAttribute('data-original', el.textContent);
    });
  }
</script>
