<!--
  Mermaid.js for architecture diagrams

  SECURITY NOTE: securityLevel='loose' is required for full Mermaid functionality
  including click handlers and entity relationships. This is acceptable because:
  - All content is author-controlled (no user-submitted diagrams)
  - Mermaid is loaded from jsdelivr CDN with integrity verification

  If user-submitted diagrams are ever supported, change to securityLevel='strict'
-->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Hugo/Chroma renders ```mermaid blocks as <pre class="chroma"><code class="language-fallback">
  // because Chroma doesn't recognize "mermaid" as a language.
  // We detect mermaid blocks by looking for code starting with mermaid keywords.
  const mermaidKeywords = ['graph ', 'flowchart ', 'sequenceDiagram', 'classDiagram', 'stateDiagram', 'erDiagram', 'gantt', 'pie ', 'gitGraph'];

  // Handle markdown code blocks (pre.chroma > code)
  const codeBlocks = Array.from(document.querySelectorAll('pre.chroma code')).filter(code => {
    const text = code.textContent.trim();
    return mermaidKeywords.some(keyword => text.startsWith(keyword));
  });

  codeBlocks.forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = codeBlock.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Handle direct <pre class="mermaid"> elements (from HTML templates)
  const preMermaidBlocks = document.querySelectorAll('pre.mermaid');
  preMermaidBlocks.forEach((pre) => {
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = pre.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Check if we have any mermaid content to render
  const hasMermaid = codeBlocks.length > 0 || preMermaidBlocks.length > 0;

  if (hasMermaid) {
    // Detect dark mode from PaperMod's data-theme attribute
    const isDarkMode = () => document.documentElement.getAttribute('data-theme') === 'dark';

    // Theme variables matching site's CSS custom properties
    const darkThemeVars = {
      background: '#1a1f2e',
      primaryColor: '#242b3d',
      primaryTextColor: '#e2e8f0',
      primaryBorderColor: '#334155',
      secondaryColor: '#334155',
      secondaryTextColor: '#e2e8f0',
      tertiaryColor: '#242b3d',
      lineColor: '#4ade80',
      textColor: '#e2e8f0',
      actorTextColor: '#e2e8f0',
      actorLineColor: '#4ade80',
      signalColor: '#4ade80',
      signalTextColor: '#e2e8f0',
      noteBkgColor: '#334155',
      noteTextColor: '#e2e8f0',
      noteBorderColor: '#4ade80'
    };

    const lightThemeVars = {
      background: '#ffffff',
      primaryColor: '#f8fafc',
      primaryTextColor: '#2d3748',
      primaryBorderColor: '#e2e8f0',
      secondaryColor: '#e2e8f0',
      secondaryTextColor: '#2d3748',
      tertiaryColor: '#f8fafc',
      lineColor: '#38a169',
      textColor: '#2d3748',
      actorTextColor: '#2d3748',
      actorLineColor: '#38a169',
      signalColor: '#38a169',
      signalTextColor: '#2d3748',
      noteBkgColor: '#f8fafc',
      noteTextColor: '#2d3748',
      noteBorderColor: '#38a169'
    };

    // Store original mermaid source BEFORE rendering (critical for theme toggle)
    document.querySelectorAll('.mermaid').forEach(el => {
      el.setAttribute('data-original', el.textContent);
    });

    const renderMermaid = () => {
      mermaid.initialize({
        startOnLoad: false,
        theme: 'base',
        themeVariables: isDarkMode() ? darkThemeVars : lightThemeVars,
        securityLevel: 'loose',
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true
        }
      });
      mermaid.run().catch(err => console.error('Mermaid render error:', err));
    };

    // Initial render
    renderMermaid();

    // Re-render when theme changes (PaperMod toggles data-theme attribute)
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-theme') {
          // Restore original source and re-render
          document.querySelectorAll('.mermaid').forEach(el => {
            const original = el.getAttribute('data-original');
            if (original) {
              el.removeAttribute('data-processed');
              el.innerHTML = original;
            }
          });
          renderMermaid();
        }
      });
    });

    observer.observe(document.documentElement, { attributes: true });
  }
</script>
