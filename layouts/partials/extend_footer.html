<!--
  Mermaid.js for architecture diagrams

  SECURITY NOTE: securityLevel='loose' is required for full Mermaid functionality
  including click handlers and entity relationships. This is acceptable because:
  - All content is author-controlled (no user-submitted diagrams)
  - Mermaid is loaded from jsdelivr CDN with integrity verification

  If user-submitted diagrams are ever supported, change to securityLevel='strict'
-->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Hugo renders ```mermaid blocks as <pre><code class="language-mermaid">
  // Mermaid.js expects <pre class="mermaid"> or <div class="mermaid">
  // Convert Hugo's output to mermaid-compatible format
  document.querySelectorAll('pre code.language-mermaid').forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = codeBlock.textContent;
    pre.parentElement.replaceChild(div, pre);
  });

  // Initialize with startOnLoad: false since DOMContentLoaded has already fired
  // by the time ES modules execute. We manually trigger rendering after conversion.
  mermaid.initialize({
    startOnLoad: false,
    theme: 'neutral',
    securityLevel: 'loose',
    flowchart: {
      useMaxWidth: true,
      htmlLabels: true
    }
  });

  // Manually render all .mermaid elements
  await mermaid.run();
</script>
